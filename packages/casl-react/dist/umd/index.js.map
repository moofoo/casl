{"version":3,"file":"index.js","sources":["../../src/Can.ts","../../src/factory.ts","../../src/hooks/useAbility.ts"],"sourcesContent":["import { Children, ReactNodeArray, PureComponent, Fragment, createElement } from 'react';\nimport {\n  Unsubscribe,\n  AbilityTuple,\n  SubjectType,\n  AnyAbility,\n  Generics,\n  Abilities,\n  IfString,\n} from '@casl/ability';\n\nconst noop = () => {};\nconst renderChildren = Fragment\n  ? (children?: ReactNodeArray) => {\n    if (!children) {\n      return null;\n    }\n\n    return children.length > 1\n      ? createElement(Fragment, null, ...children)\n      : Children.only(children);\n  }\n  : Children.only;\n\ntype AbilityCanProps<\n  T extends Abilities,\n  Else = IfString<T, { do: T } | { I: T }>\n> = T extends AbilityTuple\n  ? { do: T[0], on: T[1], field?: string } |\n  { I: T[0], a: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], an: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], this: Exclude<T[1], SubjectType>, field?: string }\n  : Else;\n\ninterface ExtraProps {\n  not?: boolean\n  passThrough?: boolean\n}\n\ninterface CanExtraProps<T extends AnyAbility> extends ExtraProps {\n  ability: T\n}\n\ninterface BoundCanExtraProps<T extends AnyAbility> extends ExtraProps {\n  ability?: T\n}\n\nexport type CanProps<T extends AnyAbility> =\n  AbilityCanProps<Generics<T>['abilities']> & CanExtraProps<T>;\nexport type BoundCanProps<T extends AnyAbility> =\n  AbilityCanProps<Generics<T>['abilities']> & BoundCanExtraProps<T>;\n\nexport class Can<\n  T extends AnyAbility,\n  IsBound extends boolean = false\n> extends PureComponent<IsBound extends true ? BoundCanProps<T> : CanProps<T>> {\n  private _isAllowed: boolean = false;\n  private _ability: T | null = null;\n  private _unsubscribeFromAbility: Unsubscribe = noop;\n\n  componentWillUnmount() {\n    this._unsubscribeFromAbility();\n  }\n\n  private _connectToAbility(ability?: T) {\n    if (ability === this._ability) {\n      return;\n    }\n\n    this._unsubscribeFromAbility();\n    this._ability = null;\n\n    if (ability) {\n      this._ability = ability;\n      this._unsubscribeFromAbility = ability.on('updated', () => this.forceUpdate());\n    }\n  }\n\n  get allowed() {\n    return this._isAllowed;\n  }\n\n  private _canRender(): boolean {\n    const props: any = this.props;\n    const subject = props.of || props.a || props.an || props.this || props.on;\n    const can = props.not ? 'cannot' : 'can';\n\n    return props.ability[can](props.I || props.do, subject, props.field);\n  }\n\n  render() {\n    this._connectToAbility(this.props.ability);\n    this._isAllowed = this._canRender();\n    return this.props.passThrough || this._isAllowed ? this._renderChildren() : null;\n  }\n\n  private _renderChildren() {\n    const { children, ability } = this.props;\n    const elements = typeof children === 'function'\n      ? children(this._isAllowed, ability)\n      : children;\n\n    return renderChildren(elements);\n  }\n}\n","import { createElement as h, ComponentClass, Consumer, StatelessComponent } from 'react';\nimport { AnyAbility } from '@casl/ability';\nimport { Can, BoundCanProps } from './Can';\n\ninterface BoundCanClass<T extends AnyAbility> extends ComponentClass<BoundCanProps<T>> {\n  new (props: BoundCanProps<T>, context?: any): Can<T, true>\n}\n\nexport function createCanBoundTo<T extends AnyAbility>(ability: T): BoundCanClass<T> {\n  return class extends Can<T, true> {\n    static defaultProps = { ability } as BoundCanClass<T>['defaultProps'];\n  };\n}\n\nexport function createContextualCan<T extends AnyAbility>(\n  Getter: Consumer<T>\n): StatelessComponent<BoundCanProps<T>> {\n  return (props: BoundCanProps<T>) => h(Getter, null, (ability: T) => h(Can, {\n    ability,\n    ...props,\n  } as any));\n}\n","import React from 'react';\nimport { AnyAbility } from '@casl/ability';\n\nexport function useAbility<T extends AnyAbility>(context: React.Context<T>): T {\n  if (process.env.NODE_ENV !== 'production' && typeof React.useContext !== 'function') {\n    /* istanbul ignore next */\n    throw new Error('You must use React >= 16.8 in order to use useAbility()');\n  }\n\n  const ability = React.useContext<T>(context);\n  const [rules, setRules] = React.useState<T['rules']>();\n\n  React.useEffect(() => ability.on('updated', (event) => {\n    if (event.rules !== rules) {\n      setRules(event.rules);\n    }\n  }), []);\n\n  return ability;\n}\n"],"names":["noop","renderChildren","Fragment","children","length","createElement","Children","only","Can","_isAllowed","_ability","_unsubscribeFromAbility","componentWillUnmount","_connectToAbility","ability","on","forceUpdate","_canRender","props","subject","of","a","an","this","can","not","I","do","field","render","passThrough","_renderChildren","elements","PureComponent","createCanBoundTo","defaultProps","createContextualCan","Getter","h","useAbility","context","process","env","NODE_ENV","React","useContext","Error","useState","rules","setRules","useEffect","event"],"mappings":"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"}