{"version":3,"file":"index.js","sources":["../../src/reactiveAbility.ts","../../src/useAbility.ts","../../src/component/can.ts","../../src/plugin.ts"],"sourcesContent":["import { AnyAbility, SubjectType } from '@casl/ability';\nimport { ref } from 'vue';\n\nexport function reactiveAbility(ability: AnyAbility) {\n  if (ability.hasOwnProperty('possibleRulesFor')) {\n    return ability;\n  }\n\n  const watcher = ref(true);\n  ability.on('updated', () => {\n    watcher.value = !watcher.value;\n  });\n\n  const possibleRulesFor = ability.possibleRulesFor.bind(ability);\n  ability.possibleRulesFor = (action: string, subject: SubjectType) => {\n    watcher.value = watcher.value; // eslint-disable-line\n    return possibleRulesFor(action, subject);\n  };\n  ability.can = ability.can.bind(ability);\n  ability.cannot = ability.cannot.bind(ability);\n\n  return ability;\n}\n","import { inject, InjectionKey, provide } from 'vue';\nimport type { AnyAbility, Ability } from '@casl/ability';\nimport { reactiveAbility } from './reactiveAbility';\n\nexport const ABILITY_TOKEN: InjectionKey<Ability> = Symbol('ability');\n\nexport function useAbility<T extends AnyAbility = Ability>(): T {\n  const ability = inject<T>(ABILITY_TOKEN);\n\n  if (!ability) {\n    throw new Error('Cannot inject Ability instance because it was not provided');\n  }\n\n  return ability;\n}\n\nexport function provideAbility(ability: AnyAbility) {\n  provide(ABILITY_TOKEN, reactiveAbility(ability));\n}\n","import { defineComponent, ComponentCustomProperties } from 'vue';\nimport {\n  SubjectType,\n  Generics,\n  AnyAbility,\n  Ability,\n  Abilities,\n  IfString,\n  AbilityTuple,\n} from '@casl/ability';\nimport { useAbility } from '../useAbility';\n\ntype AbilityCanProps<\n  T extends Abilities,\n  Else = IfString<T, { do: T } | { I: T }>\n> = T extends AbilityTuple\n  ? { do: T[0], on: T[1], field?: string } |\n  { I: T[0], a: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], an: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], this: Exclude<T[1], SubjectType>, field?: string }\n  : Else;\n\nexport type CanProps<T extends AnyAbility> = AbilityCanProps<Generics<T>['abilities']> & {\n  not?: boolean,\n  passThrough?: boolean\n};\n\ntype VueAbility = ComponentCustomProperties extends { $ability: AnyAbility }\n  ? ComponentCustomProperties['$ability']\n  : Ability;\n\nfunction detectSubjectProp(props: Record<string, unknown>) {\n  if ('a' in props) {\n    return 'a';\n  }\n\n  if ('this' in props) {\n    return 'this';\n  }\n\n  if ('an' in props) {\n    return 'an';\n  }\n\n  return '';\n}\n\nexport const Can = defineComponent<CanProps<VueAbility>>({\n  name: 'Can',\n  props: {\n    I: String,\n    do: String,\n    a: [String, Function],\n    an: [String, Function],\n    this: [String, Function, Object],\n    on: [String, Function, Object],\n    not: Boolean,\n    passThrough: Boolean,\n    field: String\n  } as any,\n  setup(props, { slots }) {\n    const $props = props as Record<string, any>;\n    let actionProp = 'do';\n    let subjectProp = 'on';\n\n    if (!(actionProp in props)) {\n      actionProp = 'I';\n      subjectProp = detectSubjectProp(props);\n    }\n\n    if (!$props[actionProp]) {\n      throw new Error('Neither `I` nor `do` prop was passed in <Can>');\n    }\n\n    if (!slots.default) {\n      throw new Error('Expects to receive default slot');\n    }\n\n    const ability = useAbility<VueAbility>();\n\n    return () => {\n      const isAllowed = ability.can($props[actionProp], $props[subjectProp], $props.field);\n      const canRender = props.not ? !isAllowed : isAllowed;\n\n      if (!props.passThrough) {\n        return canRender ? slots.default!() : null;\n      }\n\n      return slots.default!({\n        allowed: canRender,\n        ability,\n      });\n    };\n  }\n});\n","import { App } from 'vue';\nimport { AnyAbility, PureAbility } from '@casl/ability';\nimport { ABILITY_TOKEN } from './useAbility';\nimport { reactiveAbility } from './reactiveAbility';\n\nexport interface AbilityPluginOptions {\n  useGlobalProperties?: boolean\n}\n\nexport function abilitiesPlugin(app: App, ability: AnyAbility, options?: AbilityPluginOptions) {\n  if (!ability || !(ability instanceof PureAbility)) {\n    throw new Error('Please provide an Ability instance to abilitiesPlugin plugin');\n  }\n\n  app.provide(ABILITY_TOKEN, reactiveAbility(ability));\n\n  if (options && options.useGlobalProperties) {\n    app.config.globalProperties.$ability = ability;\n    app.config.globalProperties.$can = ability.can.bind(ability);\n  }\n}\n"],"names":["reactiveAbility","ability","hasOwnProperty","watcher","ref","on","value","possibleRulesFor","bind","action","subject","can","cannot","ABILITY_TOKEN","Symbol","useAbility","inject","Error","provideAbility","provide","detectSubjectProp","props","Can","defineComponent","name","I","String","do","a","Function","an","this","Object","not","Boolean","passThrough","field","setup","slots","$props","actionProp","subjectProp","default","isAllowed","canRender","allowed","abilitiesPlugin","app","options","PureAbility","useGlobalProperties","config","globalProperties","$ability","$can"],"mappings":"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"}