{"version":3,"file":"index.js","sources":["../../src/reactiveAbility.ts","../../src/useAbility.ts","../../src/component/can.ts","../../src/plugin.ts"],"sourcesContent":["import { AnyAbility, SubjectType } from '@casl/ability';\nimport { ref } from 'vue';\n\nexport function reactiveAbility(ability: AnyAbility) {\n  if (ability.hasOwnProperty('possibleRulesFor')) {\n    return ability;\n  }\n\n  const watcher = ref(true);\n  ability.on('updated', () => {\n    watcher.value = !watcher.value;\n  });\n\n  const possibleRulesFor = ability.possibleRulesFor.bind(ability);\n  ability.possibleRulesFor = (action: string, subject: SubjectType) => {\n    watcher.value = watcher.value; // eslint-disable-line\n    return possibleRulesFor(action, subject);\n  };\n  ability.can = ability.can.bind(ability);\n  ability.cannot = ability.cannot.bind(ability);\n\n  return ability;\n}\n","import { inject, InjectionKey, provide } from 'vue';\nimport type { AnyAbility, Ability } from '@casl/ability';\nimport { reactiveAbility } from './reactiveAbility';\n\nexport const ABILITY_TOKEN: InjectionKey<Ability> = Symbol('ability');\n\nexport function useAbility<T extends AnyAbility = Ability>(): T {\n  const ability = inject<T>(ABILITY_TOKEN);\n\n  if (!ability) {\n    throw new Error('Cannot inject Ability instance because it was not provided');\n  }\n\n  return ability;\n}\n\nexport function provideAbility(ability: AnyAbility) {\n  provide(ABILITY_TOKEN, reactiveAbility(ability));\n}\n","import { defineComponent, ComponentCustomProperties } from 'vue';\nimport {\n  SubjectType,\n  Generics,\n  AnyAbility,\n  Ability,\n  Abilities,\n  IfString,\n  AbilityTuple,\n} from '@casl/ability';\nimport { useAbility } from '../useAbility';\n\ntype AbilityCanProps<\n  T extends Abilities,\n  Else = IfString<T, { do: T } | { I: T }>\n> = T extends AbilityTuple\n  ? { do: T[0], on: T[1], field?: string } |\n  { I: T[0], a: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], an: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], this: Exclude<T[1], SubjectType>, field?: string }\n  : Else;\n\nexport type CanProps<T extends AnyAbility> = AbilityCanProps<Generics<T>['abilities']> & {\n  not?: boolean,\n  passThrough?: boolean\n};\n\ntype VueAbility = ComponentCustomProperties extends { $ability: AnyAbility }\n  ? ComponentCustomProperties['$ability']\n  : Ability;\n\nfunction detectSubjectProp(props: Record<string, unknown>) {\n  if ('a' in props) {\n    return 'a';\n  }\n\n  if ('this' in props) {\n    return 'this';\n  }\n\n  if ('an' in props) {\n    return 'an';\n  }\n\n  return '';\n}\n\nexport const Can = defineComponent<CanProps<VueAbility>>({\n  name: 'Can',\n  props: {\n    I: String,\n    do: String,\n    a: [String, Function],\n    an: [String, Function],\n    this: [String, Function, Object],\n    on: [String, Function, Object],\n    not: Boolean,\n    passThrough: Boolean,\n    field: String\n  } as any,\n  setup(props, { slots }) {\n    const $props = props as Record<string, any>;\n    let actionProp = 'do';\n    let subjectProp = 'on';\n\n    if (!(actionProp in props)) {\n      actionProp = 'I';\n      subjectProp = detectSubjectProp(props);\n    }\n\n    if (!$props[actionProp]) {\n      throw new Error('Neither `I` nor `do` prop was passed in <Can>');\n    }\n\n    if (!slots.default) {\n      throw new Error('Expects to receive default slot');\n    }\n\n    const ability = useAbility<VueAbility>();\n\n    return () => {\n      const isAllowed = ability.can($props[actionProp], $props[subjectProp], $props.field);\n      const canRender = props.not ? !isAllowed : isAllowed;\n\n      if (!props.passThrough) {\n        return canRender ? slots.default!() : null;\n      }\n\n      return slots.default!({\n        allowed: canRender,\n        ability,\n      });\n    };\n  }\n});\n","import { App } from 'vue';\nimport { AnyAbility, PureAbility } from '@casl/ability';\nimport { ABILITY_TOKEN } from './useAbility';\nimport { reactiveAbility } from './reactiveAbility';\n\nexport interface AbilityPluginOptions {\n  useGlobalProperties?: boolean\n}\n\nexport function abilitiesPlugin(app: App, ability: AnyAbility, options?: AbilityPluginOptions) {\n  if (!ability || !(ability instanceof PureAbility)) {\n    throw new Error('Please provide an Ability instance to abilitiesPlugin plugin');\n  }\n\n  app.provide(ABILITY_TOKEN, reactiveAbility(ability));\n\n  if (options && options.useGlobalProperties) {\n    app.config.globalProperties.$ability = ability;\n    app.config.globalProperties.$can = ability.can.bind(ability);\n  }\n}\n"],"names":["reactiveAbility","ability","hasOwnProperty","watcher","ref","on","value","possibleRulesFor","bind","action","subject","can","cannot","ABILITY_TOKEN","Symbol","useAbility","inject","Error","provideAbility","provide","detectSubjectProp","props","Can","defineComponent","name","I","String","do","a","Function","an","this","Object","not","Boolean","passThrough","field","setup","slots","$props","actionProp","subjectProp","default","isAllowed","canRender","allowed","abilitiesPlugin","app","options","PureAbility","useGlobalProperties","config","globalProperties","$ability","$can"],"mappings":"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"}